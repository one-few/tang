<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head th:replace="comm::head"></head>
<body data-spy="scroll" data-target="#myScrollspy">
<div th:replace="comm::navigation"></div>
<div class="container" id="app">
    <div class="row">

        <div class="col-md-9 column nob-p">
            <div class="panel panel-default nob" style="margin-bottom: 0px;border-bottom: 0px;border-radius: 4px 4px 0px 0px;">
                <div class="panel-body" id="blog-body" style="overflow-y:hidden;">
                    <div>
                        <span><b><a th:href="@{/author/{id}(id=${blog.username})}" th:text="${blog.nickname}"></a></b></span>
                        <span>.</span>
                        <span th:text="${blog.createDate}"></span>

                        <div class="btn-group pull-right">
                            <button class="btn btn-default btn-xs" @click="followerClick" v-text="follower.text"></button>
                            <button class="btn btn-default btn-xs" @click="commentClick">评论室</button>
                        </div>
                    </div>
                    <h3><strong th:text="${blog.title}"></strong></h3>
                    <hr>
                    <div class="markdown-body" th:utext="${blog.text}"></div>
                </div>
                <div class="panel-footer">
                    <button th:classappend="${like == 1} ? 'btn btn-danger  btn-xs' : 'btn btn-default btn-xs'" @click="likeClick" id="lkBut">推荐</button>
                    <button th:classappend="${favorite == 1} ? 'btn btn-danger  btn-xs' : 'btn btn-default btn-xs'" @click="favoriteClick" class="btn btn-default btn-xs" id="scBut">收藏</button>
                    <a th:href="'/editor?blog='+${blog.id}" class="btn btn-default btn-xs"  th:if="${session.SPRING_SECURITY_CONTEXT != null && session.SPRING_SECURITY_CONTEXT.authentication.principal.username == blog.username}">编辑</a>
                </div>


            </div>

            <div class="panel panel-default nob" style="border-radius: 0px 0px 4px 4px;padding: 0;margin: 0px;">
                <div class="panel-body"  id="plq" style="overflow-y:scroll;word-wrap:break-word">
                    <div v-for="(item,index) in comments">
                        <a v-bind:href="'/author/'+ item.username">{{item.nickname}}</a>
                        <span style="color:gainsboro" class="pull-right">{{item.createDate}}</span>
                        <span style="color:#dca492;margin-right: 10px;"
                              class="pull-right"
                              @click="deleteComment(item.id,index)"
                              v-if="item.username == user.username">删除</span>
                        <div>{{item.content}}</div><hr>
                    </div>
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input type="text" class="form-control " v-model="content">
                        <span class="input-group-btn">
                        <button type="button" class="btn btn-default" @click="send">发送</button>
                    </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 column advertise nob-p">

            <!--<div th:replace="comm::authors"></div>-->
            <div th:replace="comm::advertise"></div>


            <div id="myScrollspy" class="visible-md-block visible-lg-block">
                <ul class="nav nav-tabs nav-stacked" id="myNav" style="">
                    <li><a>目录</a></li>
                </ul>
            </div>


        </div>
    </div>
</div>
</body>
<script>
    let blogId ='[[${blog.id}]]'

    let vm = new Vue({
        el: "#app",
        data: {
            blogId:'[[${blog.id}]]',
            comments: [],
            content:"",
            pl:1,
            user:{},
            username:'[[${blog.username}]]',
            follower:{
                text:"关注",
            }

        },
        methods: {
            likeClick(){{
                    $.get("/blog/like/"+this.blogId+"/insert",function(result){

                        if (result.data == 1){
                            $("#lkBut").removeClass()
                            $("#lkBut").addClass("btn btn-danger  btn-xs")

                        }else{
                            $("#lkBut").removeClass()
                            $("#lkBut").addClass("btn btn-default btn-xs")
                        }


                    });
                }
            },
            favoriteClick(){
                $.get("/blog/favorite/"+this.blogId+"/insert",function(result,status){
                    if (result.data === 1){
                        $("#scBut").removeClass()
                        $("#scBut ").addClass("btn btn-danger  btn-xs")

                    }else{
                        $("#scBut").removeClass()
                        $("#scBut").addClass("btn btn-default btn-xs")
                    }
                });
            },
            followerClick(){
                let _this = this;
                let type,text;
                if (_this.follower.text === '已关注'){
                    type = "DELETE";
                    text = "关注"
                } else{
                    type = "POST";
                    text = "已关注"
                }
                $.ajax({
                    type:type,
                    url:"/fans/"+_this.username,
                    contentType: "application/json", //必须这样写
                    dataType:"json",
                    success:function (result) {
                        if (result.code === 200) {
                            _this.follower.text = text;
                        }
                    }
                })
            }
            ,loadFollower(){
                let _this = this;
                $.ajax({
                    type:"GET",
                    url:"/fans/"+_this.username,
                    contentType: "application/json", //必须这样写
                    success:function (result) {
                        if (result.data){
                            _this.follower.text = '已关注'
                        } else{
                            _this.follower.text = '关注'
                        }
                    }
                })
            }
            , send(){
                let dataObject = {
                    blogId:this.blogId,
                    content:this.content
                }
                let _this = this;
                $.ajax({
                    type:"POST",
                    url:"/blog/comment/insert",
                    contentType: "application/json", //必须这样写
                    dataType:"json",
                    data:JSON.stringify(dataObject),
                    async:false,
                    success:function (result) {
                        if(result.code === 200){
                            _this.content = ""
                            _this.comments.push(result.data);

                            setTimeout(function (){
                                let scrollDom = document.getElementById('plq');
                                scrollDom.scrollTop = (scrollDom.scrollHeight +10000)
                            }, 0);
                        }else{
                            alert(result.message)
                        }
                    },error(result){
                        if (result.status == 302) {
                            alert("评论需要登陆")
                        }
                    }
                })
            }
            , loadComment(){
                $.ajax({
                    type:"GET",
                    url:"/blog/comment/"+this.blogId,
                    contentType: "application/json", //必须这样写
                    dataType:"json",
                    success:function (result) {
                        vm.comments=result.data.comments
                        vm.user = result.data.user

                    }
                })
            }
            , commentClick(){
                if (this.pl % 2 != 0){
                    $("#blog-body").css("height","90px").css("overflow-x","auto")
                    $("#plq").css("height",(window.innerHeight-254)+"px")
                    $(".advertise").addClass("hidden-xs hidden-sm");
                } else{
                    $("#blog-body").css("height","").css("overflow-x","")
                    $("#plq").css("height","")
                    $(".advertise").removeClass("hidden-xs hidden-sm");
                }
                this.pl++;
            }
            , deleteComment(id,index){
                let _this = this;
                $.ajax({
                    type:"DELETE",
                    url:"/blog/comment/"+id,
                    contentType: "application/json", //必须这样写
                    dataType:"json",
                    success:function (data) {
                        if(data.code === 200){
                            _this.comments.splice(index, 1);
                        }
                    }
                })
            }
        },created(){
            this.loadFollower();
            this.loadComment();
        }
    })

    $(document).ready(function(){
        $("#myNav").affix({
            offset: {
                top: 300
            }
        });
    });

    $(function(){
        let padding=[10,25,40];
        $('.markdown-body').find('h1,h2,h3').each(function(index,item){
            let headerText=$(this).text();
            let tagName=$(this)[0].tagName.toLowerCase();
            let tagIndex=parseInt(tagName.charAt(1))-1;
            //设置不同等级header的排列及缩进样式
            $('#myNav').append($('<li style="padding-left:'+padding[tagIndex]+'px display:block;">'+'<a href="#'+$(this).attr("id")+'">'+headerText+'</a></li>'));
        });
    });


    $("#myNav").css({
        "width":$("#myScrollspy").width()+"px",
        "overflow-y":"scroll",
        "max-height":$(window).height()-340+"px"
    })

    $("#myScrollspy").css(" max-height","100px")
    $(window).resize(function () {          //当浏览器大小变化时
        $("#myNav").css({
            "width":$("#myScrollspy").width()+"px",
            "overflow-y":"scroll",
            "max-height":$(window).height()-40+"px"
        })
    });


    $(window).scroll(function(){//开始监听滚动条
        let top = $(document).scrollTop();
        if(top > 340){
            $("#myNav").css({
                "max-height":$(window).height()+"px",
                "margin"    : "0px",
                "border-radius": "0 0 0 0 "
            })
        }
        if(top < 340){
            $("#myNav").css({
                "max-height":$(window).height()-340+"px"

            })
        }
    })
</script>
</html>