<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.w3.org/1999/xhtml"
      xmlns:v-bind="http://www.w3.org/1999/xhtml"
      xmlns:v-on="http://www.w3.org/1999/xhtml">
<head th:include="comm::head"></head>
<body>
<div th:include="comm::navigation"></div>

<div class="container" id="app" v-cloak>
    <div class="row clearfix">
        <div class="col-md-4 col-md-push-8 nob-p">
            <div class="panel panel-default nob" >
                <div class="panel-body" >
                    <div>
                        <strong th:text="${user.nickname}"></strong>
                        <a href="/userinfo" th:if="${session.SPRING_SECURITY_CONTEXT !=null && session.SPRING_SECURITY_CONTEXT.authentication.principal.username == username}"><span class="glyphicon glyphicon-cog"></span></a>
                        <button v-if="bools == 'true'" class="pull-right btn btn-default btn-xs" @click="followerClick">{{follower.text}}</button>
                    </div>

                    <input type="hidden" th:value="${user.username}" id="username">
                    <hr>
                    <div>简介：<span th:text="${user.signature}"></span></div>
                </div>
            </div>
            <div class="panel panel-default nob">
                <div class="panel-body">
                    <div class="btn-group" style="width: 100%;">
                        <button class="mytab btn btn-default" v-on:click="home()">博客</button>
                        <button class="mytab btn btn-default" v-on:click="like()" th:if="${session.SPRING_SECURITY_CONTEXT !=null && session.SPRING_SECURITY_CONTEXT.authentication.principal.username == username}">收藏</button>
                        <button class="mytab btn btn-default" v-on:click="favorite()">推荐</button>
                        <button class="mytab btn btn-default" v-on:click="fans()" th:if="${session.SPRING_SECURITY_CONTEXT != null && session.SPRING_SECURITY_CONTEXT.authentication.principal.username == username}">关注</button>
                        <a class="mytab btn btn-default" @click="logout" th:if="${session.SPRING_SECURITY_CONTEXT !=null && session.SPRING_SECURITY_CONTEXT.authentication.principal.username == username}">注销</a>
                    </div>
                </div>
            </div>

            <div v-show="gzShow" class="panel panel-default nob-p" style="max-height: 300px;overflow:auto" th:if="${session.SPRING_SECURITY_CONTEXT !=null && session.SPRING_SECURITY_CONTEXT.authentication.principal.username == username}">
                <div class="list-group nob" >
                    <a href="#" class="list-group-item active nob">关注</a>
                    <a class="list-group-item nob" v-for="(item,i) in gzList" v-bind:href="item.username">{{item.nickname}}</a>
                </div>
            </div>

            <div class="nob-p visible-md-block visible-lg-block">
                <div th:replace="comm::advertise" ></div>
            </div>

        </div>
        <div class="col-md-8 col-md-pull-4 nob-p">
            <ul class="list-group col-md-12 nob" style="padding-right: 0px !important;">
            <li class="list-group-item nob" v-for="(item,index) in blogs">
                <a v-bind:href="'/post/'+item.id" class="wz">{{item.title}}</a>
                <br>
                <div>
                    <span v-text="item.createDate">2020.03.21</span>
                    <div class="btn-group pull-right">

                        <a class="btn btn-default btn-xs" v-if="update" @click="deleteBlog(item,index)" th:if="${session.SPRING_SECURITY_CONTEXT !=null && session.SPRING_SECURITY_CONTEXT.authentication.principal.username == username}">删除</a>
                        <a class="btn btn-default btn-xs" v-if="update" th:if="${session.SPRING_SECURITY_CONTEXT !=null && session.SPRING_SECURITY_CONTEXT.authentication.principal.username == username}" v-bind:href="'/editor?blog='+item.id">修改</a>
                    </div>

                </div>
            </li>
        </ul>
        </div>

    </div>

</div>
</body>
<footer th:replace="comm::footer"></footer>
<script>
    let bools = "[[${session.SPRING_SECURITY_CONTEXT != null}]]"
    let username = $("#username").val();
    new Vue({
        el: "#app",//绑定元素
        //所有数据都放在数据属性中
        data:{
            title:"土豆",//类似于模板语言
            username:username,
            blogs:[],
            bools:bools,
            gzList:[],
            gzShow:false,
            update:true,
            follower:{
                text:""
            }

        }, methods: {
            logout(){
                if(confirm("确认退出账号吗？")){
                    $.ajax({ url: "/logout", type: 'get', async: false})
                    window.location.href="/"
                }
            }
            , deleteBlog(item,index){
                let _this = this;
                if(confirm("确认删除吗？")){
                    $.ajax({
                        type:"GET",
                        url:"/blog/delete/"+item.id,
                        contentType: "application/json",
                        success:function (result) {
                            if (result.code === 200){
                                _this.blogs.splice(index,1)
                            }
                        }
                    })
                }
            }
            , followerClick(){
                let _this = this;
                let type,text;
                if (_this.follower.text === '已关注'){
                    type = "DELETE";
                    text = "关注"
                } else{
                    type = "POST";
                    text = "已关注"
                }
                $.ajax({
                    type:type,
                    url:"/fans/"+username,
                    contentType: "application/json", //必须这样写
                    dataType:"json",
                    success:function (result) {
                        if (result.code === 200) {
                            _this.follower.text = text;
                        }
                    }
                })
            }
            , loadFollower(){
                let _this = this;
                $.ajax({
                    type:"GET",
                    url:"/fans/"+username,
                    contentType: "application/json", //必须这样写
                    success:function (result) {
                        if (result.code === 200){
                            _this.follower.text = '已关注'
                        } else{
                            _this.follower.text = '关注'
                        }
                    }
                })
            }
            , like(){
                let _this = this;
                this.update = false;
                $.ajax({
                    type:"GET",
                    url:"/blog/like",
                    contentType: "application/json", //必须这样写
                    success:function (result) {
                        _this.blogs = result.data
                    }
                })
            }
            , favorite(){
                let _this = this;
                this.update = false;
                $.ajax({
                    type:"GET",
                    url:"/blog/favorite/"+this.username,
                    contentType: "application/json", //必须这样写
                    success:function (result) {
                        _this.blogs = result.data
                    }
                })
            }
            , home() {
                let _this = this;
                this.update = true;
                $.ajax({
                    type:"GET",
                    url:"/blog/home/"+this.username,
                    contentType: "application/json", //必须这样写
                    success:function (result) {
                        _this.blogs = result.data
                    }
                })
            }
            , fans(){
                if (this.gzShow){
                    this.gzShow = false;
                    return
                }
                let _this = this;
                $.ajax({
                    type:"GET",
                    url:"/user/gz",
                    contentType: "application/json", //必须这样写
                    success:function (result) {
                        _this.gzList = result.data;
                        _this.gzShow = true;
                    }
                })
            }
        },created:function(){
            if (bools==='true'){
                this.loadFollower()
            }
            this.home();
        }
    })
</script>
</html>
